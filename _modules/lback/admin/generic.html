

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>lback.admin.generic &mdash; lback 1.0.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../../../_static/custom.css?v=95f010fd" />

  
    <link rel="canonical" href="https://hemaabokila.github.io/lback-docs/_modules/lback/admin/generic.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=8d563738"></script>
      <script src="../../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            lback
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Configuration%20System.html">Configuration System</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/routing_system.html">Routing System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Views%20%26%20Responses.html">Views &amp; Responses</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Templating%20System.html">Templating System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Static%20Files.html">Static Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Media%20Files.html">Media Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/file-uploads.html">File Uploads in Lback Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Forms.html">Forms</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Models%20%26%20Database.html">Models &amp; Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Database%20Migrations%20System.html">Database Migrations System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Authentication.html">Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Authorization.html">Authorization</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/sessions.html">Sessions in Lback Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Security%20Features.html">Security Features</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Admin%20Panel.html">Built-in Admin Panel</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/API%20Tools.html">API Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Signal%20System.html">Signal System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Middleware%20System.html">Middleware System</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/custom_middlewares.html">Custom Middlewares</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/logging_config.html">Logging Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/email-sender.html">Email Sending in Lback Framework</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/validation_utilities.html">Validation Utilities</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/error_handling.html">Error Handling and HTTP Exceptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Error%20Handling%20%26%20Reporting.html">Error Handling &amp; Reporting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../features/Deployment.html">Deployment</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/api-signals.html">Signals from BaseView</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/api-signals.html#signals-from-apidocs">Signals from APIDocs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/api-signals.html#signals-from-basemodelserializer">Signals from BaseModelSerializer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/admin-registry-signals.html">Signals from AdminRegistry</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/admin-user.html">Signals from AdminUser and Role Models</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/admin-user-manager.html">Signals from AdminUserManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/admin-user-repository.html">Signals from AdminUserRepository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/auth.html">Signals from AdminAuth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/auth.html#signals-from-jwtauth">Signals from JWTAuth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/auth.html#signals-from-oauth2auth">Signals from OAuth2Auth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/auth.html#signals-from-permissionrequired">Signals from PermissionRequired</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/auth.html#signals-from-sessionauth">Signals from SessionAuth</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/error-handler.html">Signals from ErrorHandler</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/middleware-manager.html">Signals from MiddlewareManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/migration_commands.html">Signals from MigrationCommands</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/permission-repository.html">Signals from PermissionRepository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/role-repository.html">Signals from RoleRepository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/session-manager.html">Signals from SessionManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/template-renderer.html">Signals from TemplateRenderer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/user-manager.html">Signals from UserManager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/user-model.html">Signals from User Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/user-repository.html">Signals from UserRepository</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../signals/wsgi-application.html">Signals from WSGI Application and Server</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">lback</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../API%20Reference.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../lback/lback.html">lback package</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">lback</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">lback.admin.generic</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for lback.admin.generic</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">logging</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">http</span><span class="w"> </span><span class="kn">import</span> <span class="n">HTTPStatus</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">date</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">urllib.parse</span><span class="w"> </span><span class="kn">import</span> <span class="n">urljoin</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">werkzeug.datastructures</span><span class="w"> </span><span class="kn">import</span> <span class="n">MultiDict</span> 

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span><span class="p">,</span> <span class="n">or_</span><span class="p">,</span> <span class="n">and_</span><span class="p">,</span> <span class="n">asc</span><span class="p">,</span> <span class="n">desc</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">RelationshipProperty</span><span class="p">,</span> <span class="n">Query</span><span class="p">,</span> <span class="n">ColumnProperty</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">,</span> <span class="n">Text</span><span class="p">,</span> <span class="n">Date</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.exc</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegrityError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.sql.expression</span><span class="w"> </span><span class="kn">import</span> <span class="n">null</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Session</span> <span class="k">as</span> <span class="n">SQLASession</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lback.core.response</span><span class="w"> </span><span class="kn">import</span> <span class="n">Response</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.core.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">HTTPMethod</span><span class="p">,</span> <span class="n">UploadedFile</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.models.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.models.adminuser</span><span class="w"> </span><span class="kn">import</span> <span class="n">AdminUser</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">lback.core.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">Config</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.utils.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">render</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">return_404</span><span class="p">,</span> <span class="n">return_500</span><span class="p">,</span> <span class="n">get_model_form_data</span><span class="p">,</span> <span class="n">paginate_query</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.utils.file_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">save_uploaded_file</span><span class="p">,</span> <span class="n">delete_saved_file</span><span class="p">,</span> <span class="n">validate_uploaded_file</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lback.auth.permissions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PermissionRequired</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="generic_add_view">
<a class="viewcode-back" href="../../../lback/lback.admin.html#lback.admin.generic.generic_add_view">[docs]</a>
<span class="nd">@PermissionRequired</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;add_</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;add_unknown_model&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_add_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the generic &quot;add&quot; view for creating new instances of a database model.</span>

<span class="sd">    This view supports both displaying an empty form for new object creation (GET request)</span>
<span class="sd">    and processing form submissions to persist a new object to the database (POST request).</span>
<span class="sd">    It dynamically handles various SQLAlchemy column types and relationships (Many-to-One,</span>
<span class="sd">    One-to-One, Many-to-Many) based on the provided model&#39;s schema.</span>

<span class="sd">    It includes:</span>
<span class="sd">    - Dynamic permission checking using the `@PermissionRequired` decorator.</span>
<span class="sd">    - Handling of file uploads with configurable allowed types and max size.</span>
<span class="sd">    - Type conversion for different database column types (String, Integer, Boolean, DateTime, JSON).</span>
<span class="sd">    - Error handling for form validation and database integrity issues.</span>
<span class="sd">    - Redirection upon successful creation or re-rendering the form with errors.</span>

<span class="sd">    :param request: The incoming request object, containing parsed body, files,</span>
<span class="sd">                    database session, configuration, and router information.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param model: The SQLAlchemy `BaseModel` class for which a new instance is to be added.</span>
<span class="sd">    :type model: Type[BaseModel]</span>
<span class="sd">    :returns: A `Response` object, either a redirect on success, or a rendered form</span>
<span class="sd">              (potentially with errors) on failure or for initial display.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;UnknownModel&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling generic add view for model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, Method: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">db_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SQLASession</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_session</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span>
    <span class="n">router</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">router</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;_context&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;form_errors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">db_session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">router</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Missing required dependencies on request (db_session, config, router).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error: Missing dependencies.&quot;</span><span class="p">)</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;admin/generic_form.html&#39;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Processing POST request.&quot;</span><span class="p">)</span>
        <span class="n">form_data</span><span class="p">:</span> <span class="n">MultiDict</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span><span class="p">,</span> <span class="n">MultiDict</span><span class="p">)</span> <span class="k">else</span> <span class="n">MultiDict</span><span class="p">()</span>
        <span class="n">uploaded_files</span><span class="p">:</span> <span class="n">MultiDict</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">,</span> <span class="n">MultiDict</span><span class="p">)</span> <span class="k">else</span> <span class="n">MultiDict</span><span class="p">()</span>

        <span class="n">new_obj</span> <span class="o">=</span> <span class="n">model</span><span class="p">()</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">all_model_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span><span class="p">}</span>

        <span class="n">fields_to_process_later</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">all_model_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">excluded_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">,</span> <span class="s1">&#39;published_at&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;role_id&#39;</span><span class="p">,</span> <span class="s1">&#39;csrfmiddlewaretoken&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">excluded_fields</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">ColumnProperty</span><span class="p">):</span> 
                <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">is_file_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">field_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">is_file_field</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">uploaded_files</span><span class="p">:</span>
                        <span class="n">uploaded_file_object</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uploaded_files</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">uploaded_file_object</span><span class="p">:</span>
                                <span class="n">uploaded_file_object</span> <span class="o">=</span> <span class="n">uploaded_file_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Multiple files uploaded for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Processing only the first one.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">uploaded_file_object</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">UploadedFile</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Found uploaded file for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">uploaded_file_object</span><span class="o">.</span><span class="n">filename</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                            <span class="n">allowed_types</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;UPLOAD_ALLOWED_TYPES&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">max_size_mb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;UPLOAD_MAX_SIZE_MB&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">saved_file_path</span> <span class="o">=</span> <span class="n">save_uploaded_file</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span>
                                                                 <span class="n">allowed_types</span><span class="o">=</span><span class="n">allowed_types</span><span class="p">,</span> <span class="n">max_size_mb</span><span class="o">=</span><span class="n">max_size_mb</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">saved_file_path</span><span class="p">:</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">saved_file_path</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Assigned saved file path &#39;</span><span class="si">{</span><span class="n">saved_file_path</span><span class="si">}</span><span class="s2">&#39; to field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">validation_error_msg</span> <span class="o">=</span> <span class="n">validate_uploaded_file</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">allowed_types</span><span class="p">,</span> <span class="n">max_size_mb</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">validation_error_msg</span><span class="p">:</span>
                                    <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_error_msg</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: File validation failed for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">validation_error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Failed to upload file.&#39;</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Failed to save uploaded file for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; without specific validation error.&quot;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">uploaded_file_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Unexpected type for uploaded file &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping file processing.&quot;</span><span class="p">)</span>
                             <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid file format received.&#39;</span>

                <span class="k">else</span><span class="p">:</span> 
                    <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
                        <span class="n">value</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span> 
                        
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="p">:</span> 
                            <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Integer</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Invalid integer value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid integer value.&#39;</span><span class="p">})</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Invalid datetime value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid datetime value.&#39;</span><span class="p">})</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">JSON</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

                            <span class="k">except</span> <span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">):</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Invalid JSON value for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON value.&#39;</span><span class="p">})</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="p">{})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                <span class="n">relation_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">relation_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;manytoone&#39;</span><span class="p">,</span> <span class="s1">&#39;onetoone&#39;</span><span class="p">):</span>
                    <span class="n">fk_column_name</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                        <span class="n">fk_column_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">fk_column_name</span> <span class="ow">and</span> <span class="n">fk_column_name</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
                        <span class="n">fk_value</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fk_column_name</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fk_value</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">and</span> <span class="n">fk_value</span><span class="p">:</span>
                            <span class="n">fk_value</span> <span class="o">=</span> <span class="n">fk_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">fields_to_process_later</span><span class="p">[</span><span class="n">fk_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">relation_type</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">fk_value</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">}</span>

                    <span class="k">elif</span> <span class="n">fk_column_name</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                        <span class="n">fields_to_process_later</span><span class="p">[</span><span class="n">fk_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">relation_type</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">}</span>

                    <span class="k">elif</span> <span class="n">fk_column_name</span><span class="p">:</span>
                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Required FK field &#39;</span><span class="si">{</span><span class="n">fk_column_name</span><span class="si">}</span><span class="s2">&#39; not provided.&quot;</span><span class="p">)</span>
                         <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">fk_column_name</span><span class="p">:</span> <span class="s1">&#39;This field is required.&#39;</span><span class="p">})</span>

                <span class="k">elif</span> <span class="n">relation_type</span> <span class="o">==</span> <span class="s1">&#39;manytomany&#39;</span><span class="p">:</span>
                    <span class="n">form_field_name_in_html</span> <span class="o">=</span> <span class="n">field_name</span> 
                    <span class="n">received_values</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form_field_name_in_html</span><span class="si">}</span><span class="s2">[]&quot;</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">received_values</span><span class="p">:</span>
                        <span class="n">received_values</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">form_field_name_in_html</span><span class="p">)</span>

                    <span class="n">cleaned_ids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">received_values</span><span class="p">:</span> 
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cleaned_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View: Invalid ID format for M2M &#39;</span><span class="si">{</span><span class="n">form_field_name_in_html</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                    
                    <span class="n">fields_to_process_later</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">relation_type</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">cleaned_ids</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">}</span>

        <span class="n">form_errors</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">form_errors</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Form errors detected before initial save attempt. Not attempting to save.&quot;</span><span class="p">)</span>
             <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
             <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">)</span>

             <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                 <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">new_obj</span><span class="p">,</span>
                 <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                 <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Please correct the errors below.&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                 <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                 <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_obj</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">fields_to_process_later</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                 <span class="n">relation_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                 <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                 <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>

                 <span class="k">if</span> <span class="n">relation_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;manytoone&#39;</span><span class="p">,</span> <span class="s1">&#39;onetoone&#39;</span><span class="p">):</span>
                      <span class="n">fk_column_name</span> <span class="o">=</span> <span class="n">field_name</span>
                      <span class="k">try</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                              <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">fk_column_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                              
                          <span class="k">elif</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                              <span class="nb">setattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">fk_column_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Invalid integer value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for FK field &#39;</span><span class="si">{</span><span class="n">fk_column_name</span><span class="si">}</span><span class="s2">&#39; during post-add processing.&quot;</span><span class="p">)</span>

                 <span class="k">elif</span> <span class="n">relation_type</span> <span class="o">==</span> <span class="s1">&#39;manytomany&#39;</span><span class="p">:</span>
                      <span class="n">related_model</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
                      <span class="n">related_obj_ids_to_link</span> <span class="o">=</span> <span class="n">value</span> 
                      <span class="k">if</span> <span class="n">related_obj_ids_to_link</span><span class="p">:</span>
                           <span class="k">try</span><span class="p">:</span>
                               <span class="n">related_objects_to_link</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">related_model</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                   <span class="nb">getattr</span><span class="p">(</span><span class="n">related_model</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">related_obj_ids_to_link</span><span class="p">)</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                               <span class="nb">getattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">related_objects_to_link</span><span class="p">)</span>
                               
                           <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">link_e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Error linking objects for manytomany relationship &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">link_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error linking related </span><span class="si">{</span><span class="n">related_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> objects.&#39;</span><span class="p">})</span>

            <span class="n">form_errors</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">form_errors</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Form errors detected after relationship processing. Not attempting to commit.&quot;</span><span class="p">)</span>
                 <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                 <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                 <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">)</span>

                 <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                     <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                     <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                     <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                     <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                     <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">new_obj</span><span class="p">,</span>
                     <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                     <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Please correct the errors below.&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                     <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                     <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
                 <span class="p">}</span>
                 <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Successfully saved new object with ID </span><span class="si">{</span><span class="nb">getattr</span><span class="p">(</span><span class="n">new_obj</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;id&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="n">list_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/admin/</span><span class="si">{</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">redirect</span><span class="p">(</span><span class="n">list_url</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Database integrity error saving object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="n">form_errors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_general&#39;</span><span class="p">:</span> <span class="s1">&#39;Database integrity error. This might be due to duplicate unique values.&#39;</span><span class="p">}</span>
             <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="n">form_errors</span><span class="p">)</span>
             <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;error_message&#39;</span><span class="p">,</span> <span class="s2">&quot;Database error: Could not save object.&quot;</span><span class="p">)</span>
             <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
             <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">)</span>

             <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                 <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                 <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">new_obj</span><span class="p">,</span>
                 <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                 <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Database error: Could not save object. Please check your input.&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                 <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                 <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">CONFLICT</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Error saving new object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;error_message&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">new_obj</span><span class="p">)</span>

            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">new_obj</span><span class="p">,</span>
                <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Displaying add form.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">file_upload_fields</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;is_add&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s2">&quot;form_fields_data&quot;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                <span class="s2">&quot;relationship_fields_data&quot;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Add View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: Error rendering add form: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span></div>



<div class="viewcode-block" id="generic_change_view">
<a class="viewcode-back" href="../../../lback/lback.admin.html#lback.admin.generic.generic_change_view">[docs]</a>
<span class="nd">@PermissionRequired</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;change_</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;change_unknown_model&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_change_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">object_id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the generic &quot;change&quot; view for editing existing instances of a database model.</span>

<span class="sd">    This view supports both displaying a pre-filled form for editing (GET request)</span>
<span class="sd">    and processing form submissions to update an existing object in the database (POST request).</span>
<span class="sd">    It dynamically handles various SQLAlchemy column types and relationships (Many-to-One,</span>
<span class="sd">    One-to-One, Many-to-Many) based on the provided model&#39;s schema.</span>

<span class="sd">    It includes:</span>
<span class="sd">    - Dynamic permission checking using the `@PermissionRequired` decorator.</span>
<span class="sd">    - Retrieval of the existing object by `object_id`.</span>
<span class="sd">    - Handling of file uploads, including replacing old files and validating new ones.</span>
<span class="sd">    - Type conversion for different database column types (String, Integer, Boolean, DateTime, JSON).</span>
<span class="sd">    - Management of Many-to-Many relationships by clearing and re-adding associated objects.</span>
<span class="sd">    - Robust error handling for object not found, form validation, and database integrity issues.</span>
<span class="sd">    - Redirection upon successful update or re-rendering the form with errors.</span>

<span class="sd">    :param request: The incoming request object, containing parsed body, files,</span>
<span class="sd">                    database session, configuration, and router information.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param model: The SQLAlchemy `BaseModel` class whose instance is to be changed.</span>
<span class="sd">    :type model: Type[BaseModel]</span>
<span class="sd">    :param object_id: The primary key or unique identifier of the object to be changed.</span>
<span class="sd">    :type object_id: Any</span>
<span class="sd">    :returns: A `Response` object, either a redirect on success, or a rendered form</span>
<span class="sd">              (potentially with errors) on failure or for initial display.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;UnknownModel&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling generic change view for model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">, Method: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">db_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SQLASession</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_session</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span>
    <span class="n">router</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">router</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;_context&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">request</span><span class="o">.</span><span class="n">_context</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_context</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s1">&#39;form_errors&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">:</span>
        <span class="n">request</span><span class="o">.</span><span class="n">_context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">db_session</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">router</span><span class="p">]):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Missing required dependencies on request (db_session, config, router).&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error: Missing dependencies.&quot;</span><span class="p">)</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Object not found.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_404</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>

    <span class="n">template_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;admin/generic_form.html&#39;</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Processing POST request.&quot;</span><span class="p">)</span>

        <span class="n">form_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;parsed_body&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">uploaded_files</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">]]]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;files&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">all_model_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span><span class="p">}</span>
        <span class="n">fields_to_process_later</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">all_model_attributes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
             <span class="n">excluded_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">,</span> <span class="s1">&#39;published_at&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;role_id&#39;</span><span class="p">,</span> <span class="s1">&#39;csrfmiddlewaretoken&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">]</span>
             <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">excluded_fields</span><span class="p">:</span>
                 <span class="k">continue</span>
             <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                  <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">is_file_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">field_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">field_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">))</span>
                  <span class="k">if</span> <span class="n">is_file_field</span><span class="p">:</span>
                       <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">uploaded_files</span><span class="p">:</span>
                            <span class="n">uploaded_file_object</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">UploadedFile</span><span class="p">]]</span> <span class="o">=</span> <span class="n">uploaded_files</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">uploaded_file_object</span><span class="p">:</span>
                                    <span class="n">uploaded_file_object</span> <span class="o">=</span> <span class="n">uploaded_file_object</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Multiple files uploaded for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Processing only the first one.&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">uploaded_file_object</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">UploadedFile</span><span class="p">):</span>
                                <span class="n">allowed_types</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;UPLOAD_ALLOWED_TYPES&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">max_size_mb</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;UPLOAD_MAX_SIZE_MB&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">saved_file_path</span> <span class="o">=</span> <span class="n">save_uploaded_file</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">model_name</span><span class="p">,</span>
                                                                    <span class="n">allowed_types</span><span class="o">=</span><span class="n">allowed_types</span><span class="p">,</span> <span class="n">max_size_mb</span><span class="o">=</span><span class="n">max_size_mb</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">saved_file_path</span><span class="p">:</span>
                                    <span class="n">old_file_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">old_file_path</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Old file found for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">old_file_path</span><span class="si">}</span><span class="s2">. Attempting to delete.&quot;</span><span class="p">)</span>
                                        <span class="n">delete_saved_file</span><span class="p">(</span><span class="n">old_file_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

                                    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">saved_file_path</span><span class="p">)</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Assigned new saved file path &#39;</span><span class="si">{</span><span class="n">saved_file_path</span><span class="si">}</span><span class="s2">&#39; to field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">validation_error_msg</span> <span class="o">=</span> <span class="n">validate_uploaded_file</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">,</span> <span class="n">allowed_types</span><span class="p">,</span> <span class="n">max_size_mb</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="n">validation_error_msg</span><span class="p">:</span>
                                        <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">validation_error_msg</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: File validation failed for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">validation_error_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Failed to upload file.&#39;</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Failed to save uploaded file for &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; without specific validation error.&quot;</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="n">uploaded_file_object</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Unexpected type for uploaded file &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">uploaded_file_object</span><span class="p">)</span><span class="si">}</span><span class="s2">. Skipping file processing.&quot;</span><span class="p">)</span>
                                 <span class="n">request</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s1">&#39;form_errors&#39;</span><span class="p">][</span><span class="n">field_name</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Invalid file format received.&#39;</span>
                       <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: No file uploaded for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Keeping existing value.&quot;</span><span class="p">)</span>
                  <span class="k">else</span><span class="p">:</span>
                       <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">form_data</span><span class="p">[</span><span class="n">field_name</span><span class="p">]</span>

                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Set string/text field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; to &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Integer</span><span class="p">):</span>
                                 <span class="k">try</span><span class="p">:</span>
                                     <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                     <span class="k">else</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                                         
                                 <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Invalid integer value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                     <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid integer value.&#39;</span><span class="p">})</span>
                                     <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>

                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                                 <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;on&#39;</span><span class="p">)</span>
                                 
                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                                 <span class="k">try</span><span class="p">:</span>
                                     <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                         
                                     <span class="k">else</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">value</span> <span class="k">else</span> <span class="kc">None</span><span class="p">)</span>
                                         
                                 <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Invalid datetime value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                     <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid datetime value.&#39;</span><span class="p">})</span>
                                     <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">())</span>

                            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">JSON</span><span class="p">):</span>
                                 <span class="k">try</span><span class="p">:</span>
                                     <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                                         
                                     <span class="k">else</span><span class="p">:</span>
                                         <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                                         
                                 <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Invalid JSON value for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                                     <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="s1">&#39;Invalid JSON value.&#39;</span><span class="p">})</span>
                                     <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span> <span class="k">else</span> <span class="p">{})</span>
                                 <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: JSON value for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; is not a string. Keeping existing value.&quot;</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                 <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        
                       <span class="k">else</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                                 <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

             <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                 <span class="n">relation_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

                 <span class="k">if</span> <span class="n">relation_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;manytoone&#39;</span><span class="p">,</span> <span class="s1">&#39;onetoone&#39;</span><span class="p">):</span>
                     <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                         <span class="n">form_field_name_for_post</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span>
                         <span class="n">value</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">form_field_name_for_post</span><span class="p">)</span>
                         <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                              <span class="k">try</span><span class="p">:</span>
                                  <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View: Invalid ID &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for </span><span class="si">{</span><span class="n">form_field_name_for_post</span><span class="si">}</span><span class="s2"> (manytoone/onetoone).&quot;</span><span class="p">)</span>
                                  <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                         <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                              <span class="n">value</span> <span class="o">=</span> <span class="kc">None</span>
                         
                         <span class="n">fields_to_process_later</span><span class="p">[</span><span class="n">form_field_name_for_post</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">relation_type</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">}</span>
 
                 <span class="k">elif</span> <span class="n">relation_type</span> <span class="o">==</span> <span class="s1">&#39;manytomany&#39;</span><span class="p">:</span>
                    <span class="n">form_field_name</span> <span class="o">=</span> <span class="n">field_name</span>
                    <span class="n">received_values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">form_field_name</span><span class="si">}</span><span class="s2">[]&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">received_values</span><span class="p">:</span>
                        <span class="n">received_values</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">parsed_body</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="n">form_field_name</span><span class="p">)</span>

                    <span class="n">cleaned_ids</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">received_values</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">cleaned_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View: Invalid permission ID format: </span><span class="si">{</span><span class="n">item</span><span class="si">}</span><span class="s2">. Skipping.&quot;</span><span class="p">)</span>
                    
                    <span class="n">fields_to_process_later</span><span class="p">[</span><span class="n">form_field_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">relation_type</span><span class="p">,</span> <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">cleaned_ids</span><span class="p">,</span> <span class="s1">&#39;attr&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="p">}</span>

             <span class="k">elif</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">form_data</span><span class="p">:</span>
                 <span class="n">value</span> <span class="o">=</span> <span class="n">form_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                 <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">form_errors</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="k">if</span> <span class="n">form_errors</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Form errors detected before commit. Not attempting to commit.&quot;</span><span class="p">)</span>
             <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
             <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
             <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

             <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                 <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                 <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                 <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Please correct the errors below.&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                 <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                 <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>


        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">field_name</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">fields_to_process_later</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                 <span class="n">relation_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
                 <span class="n">value</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">]</span>
                 <span class="n">attr</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;attr&#39;</span><span class="p">]</span>
                 <span class="k">if</span> <span class="n">relation_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;manytoone&#39;</span><span class="p">,</span> <span class="s1">&#39;onetoone&#39;</span><span class="p">):</span>
                      <span class="n">fk_column_name</span> <span class="o">=</span> <span class="n">field_name</span>
                      <span class="k">try</span><span class="p">:</span>
                          <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
                              <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fk_column_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                              
                          <span class="k">elif</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                              <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">fk_column_name</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                              
                      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                          <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Invalid integer value &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39; for FK field &#39;</span><span class="si">{</span><span class="n">fk_column_name</span><span class="si">}</span><span class="s2">&#39; during pre-commit processing.&quot;</span><span class="p">)</span>

                 <span class="k">elif</span> <span class="n">relation_type</span> <span class="o">==</span> <span class="s1">&#39;manytomany&#39;</span><span class="p">:</span>
                      <span class="n">related_model</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
                      <span class="n">related_obj_ids_to_link</span> <span class="o">=</span> <span class="n">value</span>

                      <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                      <span class="k">if</span> <span class="n">related_obj_ids_to_link</span><span class="p">:</span>
                           <span class="k">try</span><span class="p">:</span>
                               <span class="n">related_objects_to_link</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">related_model</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                                   <span class="nb">getattr</span><span class="p">(</span><span class="n">related_model</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">related_obj_ids_to_link</span><span class="p">)</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

                               <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">related_objects_to_link</span><span class="p">)</span>

                           <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">link_e</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Error linking objects for manytomany relationship &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">link_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{</span><span class="n">field_name</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;Error linking related </span><span class="si">{</span><span class="n">related_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> objects.&#39;</span><span class="p">})</span>

            <span class="n">form_errors</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">form_errors</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Form errors detected after relationship processing. Not attempting to commit.&quot;</span><span class="p">)</span>
                 <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
                 <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
                 <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

                 <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                     <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                     <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                     <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                     <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                     <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                     <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                     <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Please correct the errors below.&quot;</span><span class="p">,</span>
                     <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                     <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                     <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
                 <span class="p">}</span>
                 <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">BAD_REQUEST</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

            <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Successfully updated object.&quot;</span><span class="p">)</span>

            <span class="n">list_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/admin/</span><span class="si">{</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">redirect</span><span class="p">(</span><span class="n">list_url</span><span class="p">)</span>
            
            <span class="k">return</span> <span class="n">response</span>

        <span class="k">except</span> <span class="n">IntegrityError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
             <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Database integrity error updating object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
             <span class="n">form_errors</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;_general&#39;</span><span class="p">:</span> <span class="s1">&#39;Database integrity error. This might be due to duplicate unique values.&#39;</span><span class="p">}</span>
             <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;form_errors&#39;</span><span class="p">,</span> <span class="n">form_errors</span><span class="p">)</span>
             <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;error_message&#39;</span><span class="p">,</span> <span class="s2">&quot;Database error: Could not update object.&quot;</span><span class="p">)</span>
             <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
             <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

             <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                 <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                 <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                 <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                 <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                 <span class="s1">&#39;form_errors&#39;</span><span class="p">:</span> <span class="n">form_errors</span><span class="p">,</span>
                 <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="s2">&quot;Database error: Could not update object. Please check your input.&quot;</span><span class="p">,</span>
                 <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                 <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                 <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
             <span class="p">}</span>
             <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">CONFLICT</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Error updating object: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">add_context</span><span class="p">(</span><span class="s1">&#39;error_message&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

            <span class="n">context</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;model_name&#39;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                <span class="s1">&#39;is_add&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s1">&#39;form_fields_data&#39;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;relationship_fields_data&#39;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;error_message&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span>


    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Displaying change form.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">form_fields_data</span><span class="p">,</span> <span class="n">relationship_fields_data</span><span class="p">,</span> <span class="n">file_upload_fields</span> <span class="o">=</span> <span class="n">get_model_form_data</span><span class="p">(</span><span class="n">db_session</span><span class="p">,</span> <span class="n">mapper</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

            <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
                <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
                <span class="s2">&quot;is_add&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;form_fields_data&quot;</span><span class="p">:</span> <span class="n">form_fields_data</span><span class="p">,</span>
                <span class="s2">&quot;relationship_fields_data&quot;</span><span class="p">:</span> <span class="n">relationship_fields_data</span><span class="p">,</span>
                <span class="s1">&#39;admin_base_template&#39;</span><span class="p">:</span> <span class="s1">&#39;admin/base.html&#39;</span><span class="p">,</span>
                <span class="s1">&#39;router&#39;</span><span class="p">:</span> <span class="n">router</span><span class="p">,</span>
                <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">config</span><span class="p">,</span>
                <span class="s1">&#39;request&#39;</span><span class="p">:</span> <span class="n">request</span>
            <span class="p">}</span>

            <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">template_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Change View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Error rendering change form: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="generic_list_view">
<a class="viewcode-back" href="../../../lback/lback.admin.html#lback.admin.generic.generic_list_view">[docs]</a>
<span class="nd">@PermissionRequired</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;view_unknown_model&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_list_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the generic &quot;list&quot; view for displaying, searching, filtering, and paginating</span>
<span class="sd">    instances of a database model.</span>

<span class="sd">    This view dynamically generates a list of objects based on the provided model&#39;s schema</span>
<span class="sd">    and query parameters. It supports various SQLAlchemy column types and relationships</span>
<span class="sd">    for advanced filtering and sorting capabilities.</span>

<span class="sd">    It includes:</span>
<span class="sd">    - Dynamic permission checking using the `@PermissionRequired` decorator, ensuring users</span>
<span class="sd">      can only view models they are authorized to access.</span>
<span class="sd">    - Retrieval and pagination of model instances from the database.</span>
<span class="sd">    - Full-text search functionality across string-based columns.</span>
<span class="sd">    - Advanced filtering options:</span>
<span class="sd">        - Range filtering for date/datetime and numeric fields (e.g., `created_at_min`, `price_max`).</span>
<span class="sd">        - Null/Not Null checks for any field, including relationship foreign keys (e.g., `author_id_isnull=true`).</span>
<span class="sd">        - Exact match filtering for boolean, integer, float, and string fields.</span>
<span class="sd">        - Filtering based on Many-to-One relationships (e.g., selecting objects linked to a specific related entity).</span>
<span class="sd">        - Filtering based on Many-to-Many relationships (e.g., finding objects associated with a particular related entity).</span>
<span class="sd">        - Filtering for the existence/non-existence of One-to-One related objects.</span>
<span class="sd">    - Customizable sorting by any sortable model column, in ascending or descending order.</span>
<span class="sd">    - Dynamic determination of fields to display in the list, excluding sensitive or overly large fields by default.</span>
<span class="sd">    - Generation of metadata for filter controls to be used in the UI, including available choices for</span>
<span class="sd">      relationship-based filters.</span>
<span class="sd">    - Robust error handling for database session issues or unexpected exceptions during processing.</span>
<span class="sd">    - Rendering of an HTML template (`admin/generic_list.html`) with the prepared data.</span>

<span class="sd">    :param request: The incoming request object, containing query parameters,</span>
<span class="sd">                    path parameters, database session, and other request-specific data.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param model: The SQLAlchemy `BaseModel` class whose instances are to be listed.</span>
<span class="sd">    :type model: Type[BaseModel]</span>
<span class="sd">    :returns: A `Response` object, typically a rendered HTML page displaying the list</span>
<span class="sd">              of objects, or an error response if issues occur (e.g., database session missing).</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;UnknownModel&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rendering generic list view for model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">db_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SQLASession</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_session</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_session</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database session is not available in generic_list_view for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error: Database session missing.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;per_page&#39;</span><span class="p">,</span> <span class="mi">20</span><span class="p">))</span>
        <span class="n">page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
        <span class="n">per_page</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">per_page</span><span class="p">)</span>
        <span class="n">search_query</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        
        <span class="n">filter_params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;page&#39;</span><span class="p">,</span> <span class="s1">&#39;per_page&#39;</span><span class="p">,</span> <span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;sort_order&#39;</span><span class="p">]</span>
        <span class="p">}</span>
        
        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort_by&#39;</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">)</span>
        <span class="n">sort_order</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">query_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;sort_order&#39;</span><span class="p">,</span> <span class="s1">&#39;asc&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sort_order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;asc&#39;</span><span class="p">,</span> <span class="s1">&#39;desc&#39;</span><span class="p">]:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid sort_order &#39;</span><span class="si">{</span><span class="n">sort_order</span><span class="si">}</span><span class="s2">&#39; received. Defaulting to &#39;asc&#39;.&quot;</span><span class="p">)</span>
            <span class="n">sort_order</span> <span class="o">=</span> <span class="s1">&#39;asc&#39;</span>

        <span class="n">base_query</span><span class="p">:</span> <span class="n">Query</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">search_query</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">searchable_fields</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">searchable_fields</span><span class="p">:</span>
                <span class="n">search_conditions</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">searchable_fields</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">):</span>
                         <span class="n">search_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                             <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;%</span><span class="si">{</span><span class="n">search_query</span><span class="si">}</span><span class="s2">%&quot;</span><span class="p">)</span>
                         <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                         <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searchable field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; not found as an attribute on model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Skipping search condition for this field.&quot;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">search_conditions</span><span class="p">:</span>
                    <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="o">*</span><span class="n">search_conditions</span><span class="p">))</span>
                    
                <span class="k">else</span><span class="p">:</span>
                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No valid searchable fields found for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> after checking attributes.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No searchable fields found for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Search query &#39;</span><span class="si">{</span><span class="n">search_query</span><span class="si">}</span><span class="s2">&#39; will be ignored.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">filter_params</span><span class="p">:</span>
            <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
            <span class="n">filter_conditions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">filterable_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">)}</span>
            <span class="n">processed_filter_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">param_key</span><span class="p">,</span> <span class="n">param_value</span> <span class="ow">in</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">param_key</span> <span class="ow">in</span> <span class="n">processed_filter_keys</span> <span class="ow">or</span> <span class="n">param_value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">param_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_min&#39;</span><span class="p">):</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">param_key</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
                    <span class="n">max_param_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">_max&quot;</span>
                    <span class="n">processed_filter_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">param_key</span><span class="p">)</span>
                    <span class="n">processed_filter_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">max_param_key</span><span class="p">)</span>

                    <span class="n">attr</span> <span class="o">=</span> <span class="n">filterable_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                         <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="n">min_value_str</span> <span class="o">=</span> <span class="n">param_value</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                         <span class="n">max_value_str</span> <span class="o">=</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">max_param_key</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                         <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">Date</span><span class="p">)):</span>
                              <span class="n">min_date</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="n">max_date</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="k">try</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="n">min_value_str</span><span class="p">:</span>
                                       <span class="n">min_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">min_value_str</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span> <span class="k">else</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">min_value_str</span><span class="p">)</span>
                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">min_date</span><span class="p">)</span>
                                       
                              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid date/datetime min value &#39;</span><span class="si">{</span><span class="n">min_value_str</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                              <span class="k">try</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="n">max_value_str</span><span class="p">:</span>
                                       <span class="n">max_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">max_value_str</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span> <span class="k">else</span> <span class="n">date</span><span class="o">.</span><span class="n">fromisoformat</span><span class="p">(</span><span class="n">max_value_str</span><span class="p">)</span>
                                       <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">max_date</span><span class="p">,</span> <span class="n">date</span><span class="p">):</span>
                                           <span class="n">max_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">combine</span><span class="p">(</span><span class="n">max_date</span><span class="p">,</span> <span class="n">datetime</span><span class="o">.</span><span class="n">max</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>

                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">&lt;=</span> <span class="n">max_date</span><span class="p">)</span>
                                       
                              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid date/datetime max value &#39;</span><span class="si">{</span><span class="n">max_value_str</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">)):</span>
                              <span class="n">min_num</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="n">max_num</span> <span class="o">=</span> <span class="kc">None</span>
                              <span class="k">try</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="n">min_value_str</span><span class="p">:</span>
                                       <span class="n">min_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">min_value_str</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">))</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_value_str</span><span class="p">)</span>
                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">&gt;=</span> <span class="n">min_num</span><span class="p">)</span>
                                       
                              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid numeric min value &#39;</span><span class="si">{</span><span class="n">min_value_str</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                              <span class="k">try</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="n">max_value_str</span><span class="p">:</span>
                                       <span class="n">max_num</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">max_value_str</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">))</span> <span class="k">else</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_value_str</span><span class="p">)</span>
                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">&lt;=</span> <span class="n">max_num</span><span class="p">)</span>
                                       
                              <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid numeric max value &#39;</span><span class="si">{</span><span class="n">max_value_str</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                         <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Range filter requested for non-numeric/non-date field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). Skipping.&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">param_key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_isnull&#39;</span><span class="p">):</span>
                    <span class="n">field_name</span> <span class="o">=</span> <span class="n">param_key</span><span class="p">[:</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>
                    <span class="n">processed_filter_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">param_key</span><span class="p">)</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">filterable_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">attr</span><span class="p">:</span>
                         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                              <span class="n">column_or_relation</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                         <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                              <span class="n">column_or_relation</span> <span class="o">=</span> <span class="n">attr</span>

                         <span class="k">if</span> <span class="n">column_or_relation</span><span class="p">:</span>
                              <span class="k">if</span> <span class="n">param_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">column_or_relation</span><span class="p">,</span> <span class="s1">&#39;is_&#39;</span><span class="p">):</span>
                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="n">null</span><span class="p">()))</span>
                                       <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnull filter: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> IS NULL&quot;</span><span class="p">)</span>

                                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_or_relation</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                                       <span class="k">if</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MANYTOONE&#39;</span><span class="p">,</span> <span class="s1">&#39;ONETOONE&#39;</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                                                 <span class="n">fk_column</span> <span class="o">=</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                                 <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_column</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="n">null</span><span class="p">()))</span>
                                                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnull filter for relationship </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: FK IS NULL&quot;</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine FK for relationship &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; for isnull filter.&quot;</span><span class="p">)</span>
                                       <span class="k">elif</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOMANY&#39;</span><span class="p">:</span>
                                            <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">~</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnull filter for Many-to-Many relationship </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: ~any()&quot;</span><span class="p">)</span>
                                       <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported relationship direction &#39;</span><span class="si">{</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for isnull filter on &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                              <span class="k">elif</span> <span class="n">param_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                                  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">column_or_relation</span><span class="p">,</span> <span class="s1">&#39;isnot&#39;</span><span class="p">):</span>
                                       <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="n">null</span><span class="p">()))</span>
                                       <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnotnull filter: </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2"> IS NOT NULL&quot;</span><span class="p">)</span>

                                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_or_relation</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                                       <span class="k">if</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;MANYTOONE&#39;</span><span class="p">,</span> <span class="s1">&#39;ONETOONE&#39;</span><span class="p">):</span>
                                            <span class="k">if</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                                                 <span class="n">fk_column</span> <span class="o">=</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                                 <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_column</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="n">null</span><span class="p">()))</span>
                                                 <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnotnull filter for relationship </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: FK IS NOT NULL&quot;</span><span class="p">)</span>
                                            <span class="k">else</span><span class="p">:</span>
                                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine FK for relationship &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; for isnotnull filter.&quot;</span><span class="p">)</span>
                                       <span class="k">elif</span> <span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOMANY&#39;</span><span class="p">:</span>
                                            <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">any</span><span class="p">())</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applied isnotnull filter for Many-to-Many relationship </span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">: any()&quot;</span><span class="p">)</span>
                                       <span class="k">else</span><span class="p">:</span>
                                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported relationship direction &#39;</span><span class="si">{</span><span class="n">column_or_relation</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; for isnotnull filter on &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>
                              <span class="k">else</span><span class="p">:</span>
                                  <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid isnull filter value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;. Expected &#39;true&#39; or &#39;false&#39;.&quot;</span><span class="p">)</span>
                         <span class="k">else</span><span class="p">:</span>
                              <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Nullable filter requested for attribute &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; which is not a column or Relationship. Skipping.&quot;</span><span class="p">)</span>

                <span class="k">elif</span> <span class="n">param_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">processed_filter_keys</span><span class="p">:</span>
                    <span class="n">attr</span> <span class="o">=</span> <span class="n">filterable_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">param_key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                         <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOONE&#39;</span><span class="p">:</span>
                             <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                                 <span class="n">fk_column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                 <span class="k">try</span><span class="p">:</span>
                                     <span class="n">fk_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
                                     <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fk_column</span> <span class="o">==</span> <span class="n">fk_value</span><span class="p">)</span>
                                     
                                 <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                     <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integer value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for Many-to-One filter field &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39; (FK column: </span><span class="si">{</span><span class="n">fk_column</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>
                             <span class="k">else</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not determine FK column for Many-to-One relationship &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;. Skipping filter.&quot;</span><span class="p">)</span>

                         <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOMANY&#39;</span><span class="p">:</span>
                             <span class="n">related_model</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
                             <span class="k">try</span><span class="p">:</span>
                                 <span class="n">related_obj_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
                                 <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">related_model</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">related_obj_id</span><span class="p">))</span>
                                 
                             <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integer value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for Many-to-Many filter field &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;. Expected related object ID.&quot;</span><span class="p">)</span>
                             <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">manytomany_filter_e</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error applying Many-to-Many filter for &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">manytomany_filter_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                        <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">param_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">]:</span>
                                <span class="n">boolean_value</span> <span class="o">=</span> <span class="n">param_value</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span>
                                <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="n">boolean_value</span><span class="p">)</span>
                                
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid boolean filter value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Integer</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">int_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
                                <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="n">int_value</span><span class="p">)</span>
                                
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid integer filter value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">)):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">float_value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">param_value</span><span class="p">)</span>
                                <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="n">float_value</span><span class="p">)</span>
                                
                            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid numeric filter value &#39;</span><span class="si">{</span><span class="n">param_value</span><span class="si">}</span><span class="s2">&#39; for field &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span><span class="p">)</span>

                        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">)):</span>
                             <span class="n">filter_conditions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">column</span> <span class="o">==</span> <span class="n">param_value</span><span class="p">)</span>  

                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Filter parameter &#39;</span><span class="si">{</span><span class="n">param_key</span><span class="si">}</span><span class="s2">&#39; does not correspond to a filterable model attribute on </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">. Skipping filter.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">filter_conditions</span><span class="p">:</span>
                <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="o">*</span><span class="n">filter_conditions</span><span class="p">))</span>

        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">sortable_attributes</span> <span class="o">=</span> <span class="p">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="p">:</span> <span class="n">attr</span> <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">sort_by</span> <span class="ow">in</span> <span class="n">sortable_attributes</span><span class="p">:</span>
             <span class="n">sort_column</span> <span class="o">=</span> <span class="n">sortable_attributes</span><span class="p">[</span><span class="n">sort_by</span><span class="p">]</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
             <span class="k">if</span> <span class="n">sort_order</span> <span class="o">==</span> <span class="s1">&#39;asc&#39;</span><span class="p">:</span>
                  <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">asc</span><span class="p">(</span><span class="n">sort_column</span><span class="p">))</span>
                  
             <span class="k">else</span><span class="p">:</span>
                  <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">desc</span><span class="p">(</span><span class="n">sort_column</span><span class="p">))</span>
                  
        <span class="k">else</span><span class="p">:</span>
             <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid or non-sortable field &#39;</span><span class="si">{</span><span class="n">sort_by</span><span class="si">}</span><span class="s2">&#39; for sorting. Defaulting to sorting by &#39;id&#39; ASC.&quot;</span><span class="p">)</span>
             <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">):</span>
                 <span class="n">base_query</span> <span class="o">=</span> <span class="n">base_query</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">asc</span><span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                 <span class="n">sort_by</span> <span class="o">=</span> <span class="s1">&#39;id&#39;</span>
                 <span class="n">sort_order</span> <span class="o">=</span> <span class="s1">&#39;asc&#39;</span>
             <span class="k">else</span><span class="p">:</span>
                 <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> does not have an &#39;id&#39; column. No default sorting applied.&quot;</span><span class="p">)</span>
                 <span class="n">sort_by</span> <span class="o">=</span> <span class="kc">None</span>
                 <span class="n">sort_order</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">pagination_data</span> <span class="o">=</span> <span class="n">paginate_query</span><span class="p">(</span><span class="n">base_query</span><span class="p">,</span> <span class="n">page</span><span class="o">=</span><span class="n">page</span><span class="p">,</span> <span class="n">per_page</span><span class="o">=</span><span class="n">per_page</span><span class="p">)</span>
        <span class="n">paginated_objects</span> <span class="o">=</span> <span class="n">pagination_data</span><span class="p">[</span><span class="s1">&#39;objects&#39;</span><span class="p">]</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">all_columns</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">columns</span>
        <span class="n">excluded_fields_from_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="s1">&#39;updated_at&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;role_id&#39;</span><span class="p">]</span>
        <span class="n">excluded_fields_from_list</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_columns</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">))])</span>
        <span class="n">excluded_fields_from_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">excluded_fields_from_list</span><span class="p">))</span>
        <span class="n">fields_to_display_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sortable_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">all_columns</span> <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_fields_from_list</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">JSON</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">all_columns</span><span class="p">:</span>
             <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">excluded_fields_from_list</span><span class="p">:</span>
                  <span class="n">field_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Date</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;boolean&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Integer</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;integer&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">String</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">JSON</span><span class="p">):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">)):</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;numeric&#39;</span>
                  <span class="k">else</span><span class="p">:</span>
                       <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>

                  <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;sortable&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">sortable_columns</span>
                  <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;is_current_sort&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">field_data</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">sort_by</span>
                  <span class="n">fields_to_display_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">field_data</span><span class="p">)</span>

        <span class="n">fields_to_display_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fields_to_display_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>
        <span class="n">filterable_fields_data</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
             <span class="n">field_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span>
             <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                  <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">column_type</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">type</span>
                  <span class="n">column_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span>
                  <span class="n">is_nullable</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">nullable</span>
                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                       <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">,</span>
                           <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;boolean&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">[</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;-- All </span><span class="si">{</span><span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> --&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;True&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Yes&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;False&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;No&#39;</span><span class="p">},</span>
                           <span class="p">],</span>
                           <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">column_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                       <span class="p">}</span>

                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="p">(</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">Date</span><span class="p">)):</span>
                       <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">,</span>
                           <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;date_range&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;date_range_inputs&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;current_min_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">_min&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                           <span class="s1">&#39;current_max_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">_max&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                       <span class="p">}</span>

                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Float</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">)):</span>
                       <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="p">,</span>
                           <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;numeric_range&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;numeric_range_inputs&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;current_min_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">_min&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                           <span class="s1">&#39;current_max_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">_max&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                       <span class="p">}</span>
                       
                  <span class="k">if</span> <span class="n">is_nullable</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column_type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                       <span class="n">nullable_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="si">}</span><span class="s1">_isnull&#39;</span>
                       <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">nullable_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">nullable_param_name</span><span class="p">,</span>
                           <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">column_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> (Is Null)&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;nullable&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">[</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;-- All --&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Null&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Not Null&#39;</span><span class="p">},</span>
                           <span class="p">],</span>
                           <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nullable_param_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                       <span class="p">}</span>

             <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                  <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOONE&#39;</span><span class="p">:</span>
                       <span class="n">fk_column_name</span> <span class="o">=</span> <span class="kc">None</span>
                       <span class="n">is_nullable_fk</span> <span class="o">=</span> <span class="kc">False</span>
                       <span class="k">if</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">:</span>
                            <span class="n">fk_column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">local_remote_pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="n">fk_column_name</span> <span class="o">=</span> <span class="n">fk_column</span><span class="o">.</span><span class="n">name</span>
                            <span class="n">is_nullable_fk</span> <span class="o">=</span> <span class="n">fk_column</span><span class="o">.</span><span class="n">nullable</span> 
                       <span class="k">if</span> <span class="n">fk_column_name</span><span class="p">:</span>
                            <span class="n">related_model</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">related_objects</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">related_model</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">related_model</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                                <span class="n">filter_choices</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">related_objects</span><span class="p">]</span>
                                <span class="n">filter_choices</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;-- All </span><span class="si">{</span><span class="n">related_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> --&#39;</span><span class="p">})</span>

                                <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">fk_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                    <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">fk_column_name</span><span class="p">,</span>
                                    <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;manytoone&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                                    <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="n">filter_choices</span><span class="p">,</span>
                                    <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">fk_column_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                <span class="p">}</span>
                                
                                <span class="k">if</span> <span class="n">is_nullable_fk</span><span class="p">:</span>
                                     <span class="n">nullable_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">fk_column_name</span><span class="si">}</span><span class="s1">_isnull&#39;</span>
                                     <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">nullable_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                                         <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">nullable_param_name</span><span class="p">,</span>
                                         <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> (Is Null)&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;nullable&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                                         <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">[</span>
                                             <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;-- All --&#39;</span><span class="p">},</span>
                                             <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Null&#39;</span><span class="p">},</span>
                                             <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Not Null&#39;</span><span class="p">},</span>
                                         <span class="p">],</span>
                                         <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nullable_param_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                                     <span class="p">}</span>
                                     
                            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">related_query_e</span><span class="p">:</span>
                                 <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying related objects for filtering &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">related_query_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                  <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MANYTOMANY&#39;</span><span class="p">:</span>
                       <span class="n">related_model</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">class_</span>
                       <span class="n">relation_param_base</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span>

                       <span class="k">try</span><span class="p">:</span>
                           <span class="n">related_objects</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">related_model</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">related_model</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                           <span class="n">filter_choices</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)),</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">)}</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">related_objects</span><span class="p">]</span>
                           <span class="n">filter_choices</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;-- All </span><span class="si">{</span><span class="n">related_model</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s1"> --&#39;</span><span class="p">})</span>
                           <span class="n">specific_related_param_name</span> <span class="o">=</span> <span class="n">relation_param_base</span>
                           <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">specific_related_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                               <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">specific_related_param_name</span><span class="p">,</span>
                               <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39; &#39;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">(),</span>
                               <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;manytomany_specific&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="n">filter_choices</span><span class="p">,</span>
                               <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">specific_related_param_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                           <span class="p">}</span>
                           
                           <span class="n">nullable_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">relation_param_base</span><span class="si">}</span><span class="s1">_isnull&#39;</span>
                           <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">nullable_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                               <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">nullable_param_name</span><span class="p">,</span>
                               <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> (Is Null)&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;nullable&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                               <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">[</span>
                                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;-- All --&#39;</span><span class="p">},</span>
                                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Null (Has None)&#39;</span><span class="p">},</span>
                                   <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Not Null (Has Any)&#39;</span><span class="p">},</span>
                               <span class="p">],</span>
                               <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nullable_param_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                           <span class="p">}</span>

                       <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">related_query_e</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error querying related objects for Many-to-Many filtering &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; on model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">related_query_e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                  <span class="k">elif</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ONETOONE&#39;</span><span class="p">:</span>
                       <span class="n">relation_param_base</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span>

                       <span class="n">nullable_param_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">relation_param_base</span><span class="si">}</span><span class="s1">_isnull&#39;</span>
                       <span class="n">filterable_fields_data</span><span class="p">[</span><span class="n">nullable_param_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                           <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">nullable_param_name</span><span class="p">,</span>
                           <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">capitalize</span><span class="p">()</span><span class="si">}</span><span class="s1"> (Is Null)&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;nullable&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="s1">&#39;select&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;choices&#39;</span><span class="p">:</span> <span class="p">[</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;-- All --&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Null (Does Not Exist)&#39;</span><span class="p">},</span>
                               <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;Is Not Null (Exists)&#39;</span><span class="p">},</span>
                           <span class="p">],</span>
                           <span class="s1">&#39;current_value&#39;</span><span class="p">:</span> <span class="n">filter_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">nullable_param_name</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                       <span class="p">}</span>
                       

        <span class="n">filterable_fields_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">filterable_fields_data</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;label&#39;</span><span class="p">]))</span>

        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
            <span class="s2">&quot;objects&quot;</span><span class="p">:</span> <span class="n">paginated_objects</span><span class="p">,</span>
            <span class="s2">&quot;fields_to_display&quot;</span><span class="p">:</span> <span class="n">fields_to_display_data</span><span class="p">,</span>
            <span class="s2">&quot;pagination&quot;</span><span class="p">:</span> <span class="n">pagination_data</span><span class="p">,</span>
            <span class="s2">&quot;search_query&quot;</span><span class="p">:</span> <span class="n">search_query</span><span class="p">,</span>
            <span class="s2">&quot;filter_params&quot;</span><span class="p">:</span> <span class="n">filter_params</span><span class="p">,</span>
            <span class="s2">&quot;filterable_fields_data&quot;</span><span class="p">:</span> <span class="n">filterable_fields_data</span><span class="p">,</span>
            <span class="s2">&quot;current_sort_by&quot;</span><span class="p">:</span> <span class="n">sort_by</span><span class="p">,</span>
            <span class="s2">&quot;current_sort_order&quot;</span><span class="p">:</span> <span class="n">sort_order</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin/generic_list.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error rendering generic list view for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="generic_detail_view">
<a class="viewcode-back" href="../../../lback/lback.admin.html#lback.admin.generic.generic_detail_view">[docs]</a>
<span class="nd">@PermissionRequired</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;view_unknown_model&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_detail_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">object_id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the generic &quot;detail&quot; view for displaying the attributes of a single</span>
<span class="sd">    instance of a database model.</span>

<span class="sd">    This view retrieves a specific object by its ID and dynamically prepares its fields</span>
<span class="sd">    for display. It handles various SQLAlchemy column types and relationships,</span>
<span class="sd">    formatting them appropriately for presentation in a detail page.</span>

<span class="sd">    It includes:</span>
<span class="sd">    - Dynamic permission checking using the `@PermissionRequired` decorator to ensure</span>
<span class="sd">      the user is authorized to view the specific model&#39;s details.</span>
<span class="sd">    - Retrieval of the existing object by `object_id` from the database.</span>
<span class="sd">    - Handling of &quot;object not found&quot; scenarios by returning a 404 response.</span>
<span class="sd">    - Exclusion of sensitive or internal fields (e.g., &#39;id&#39;, &#39;password&#39;) from display.</span>
<span class="sd">    - Special formatting for different data types:</span>
<span class="sd">        - SQLAlchemy Relationships (ManyToOne, OneToOne): Displays string representation.</span>
<span class="sd">        - SQLAlchemy Relationships (ManyToMany): Displays a list of string representations.</span>
<span class="sd">        - File/Path Fields (ending with `_file` or `_path`): Constructs a full URL for download/display</span>
<span class="sd">          based on `UPLOAD_URL` from `request.config`.</span>
<span class="sd">        - JSON Fields: Pretty-prints the JSON content.</span>
<span class="sd">        - Boolean Fields: Displays &quot;Yes&quot; or &quot;No&quot;.</span>
<span class="sd">        - DateTime Fields: Formats as &quot;YYYY-MM-DD HH:MM:SS&quot;.</span>
<span class="sd">        - Other standard column types are displayed as is.</span>
<span class="sd">    - Sorting of displayed fields alphabetically by name for consistent presentation.</span>
<span class="sd">    - Robust error handling for missing database session/configuration or other runtime exceptions,</span>
<span class="sd">      returning a 500 response.</span>
<span class="sd">    - Rendering of an HTML template (`admin/generic_detail.html`) with the object&#39;s details.</span>

<span class="sd">    :param request: The incoming request object, containing path parameters,</span>
<span class="sd">                    database session, application configuration, etc.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param model: The SQLAlchemy `BaseModel` class whose instance details are to be viewed.</span>
<span class="sd">    :type model: Type[BaseModel]</span>
<span class="sd">    :param object_id: The primary key or unique identifier of the object to be displayed.</span>
<span class="sd">    :type object_id: Any</span>
<span class="sd">    :returns: A `Response` object, typically a rendered HTML page showing the object&#39;s</span>
<span class="sd">              details, or an HTTP 404/500 error response if the object is not found</span>
<span class="sd">              or an internal error occurs.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;UnknownModel&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Rendering generic detail view for model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

    <span class="n">db_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SQLASession</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_session</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_session</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database session or Config is not available in generic_detail_view for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error: Database session or Config missing.&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_id</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> not found for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> in detail view for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">return_404</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> not found.&quot;</span><span class="p">)</span>


        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="n">fields_to_display_data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">upload_url_base</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s1">&#39;UPLOAD_URL&#39;</span><span class="p">,</span> <span class="s1">&#39;/uploads/&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
             <span class="n">field_name</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span>
             <span class="n">excluded_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">,</span> <span class="s1">&#39;role_id&#39;</span><span class="p">,</span> <span class="s1">&#39;csrfmiddlewaretoken&#39;</span><span class="p">,</span> <span class="s1">&#39;slug&#39;</span><span class="p">]</span>

             <span class="k">if</span> <span class="n">field_name</span> <span class="ow">in</span> <span class="n">excluded_fields</span><span class="p">:</span>
                 <span class="k">continue</span>

             <span class="n">field_value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
             <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>
             <span class="n">display_value</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="n">field_value</span>

             <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="n">RelationshipProperty</span><span class="p">):</span>
                  <span class="n">relation_type</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">direction</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                  <span class="n">field_type</span> <span class="o">=</span> <span class="n">relation_type</span> 

                  <span class="k">if</span> <span class="n">relation_type</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;manytoone&#39;</span><span class="p">,</span> <span class="s1">&#39;onetoone&#39;</span><span class="p">):</span>
                       <span class="n">display_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_value</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

                  <span class="k">elif</span> <span class="n">relation_type</span> <span class="o">==</span> <span class="s1">&#39;manytomany&#39;</span><span class="p">:</span>
                       <span class="k">if</span> <span class="n">field_value</span><span class="p">:</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                                <span class="n">display_value</span> <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">related_obj</span><span class="p">)</span> <span class="k">for</span> <span class="n">related_obj</span> <span class="ow">in</span> <span class="n">field_value</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Detail View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Unexpected type for manytomany relationship &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span><span class="si">}</span><span class="s2">. Displaying raw value.&quot;</span><span class="p">)</span>
                                <span class="n">display_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_value</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                       <span class="k">else</span><span class="p">:</span>
                            <span class="n">display_value</span> <span class="o">=</span> <span class="p">[]</span>

             <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                  <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                  <span class="n">column_name</span> <span class="o">=</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span>

                  <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">column_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">column_name</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">)):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;file_upload&#39;</span>
                       <span class="k">if</span> <span class="n">field_value</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">file_url</span> <span class="o">=</span> <span class="n">urljoin</span><span class="p">(</span><span class="n">upload_url_base</span><span class="p">,</span> <span class="n">field_value</span><span class="p">)</span>
                            <span class="n">display_value</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">file_url</span><span class="p">,</span> <span class="s1">&#39;path&#39;</span><span class="p">:</span> <span class="n">field_value</span><span class="p">,</span> <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">field_value</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span><span class="p">)}</span>
                       <span class="k">else</span><span class="p">:</span>
                            <span class="n">display_value</span> <span class="o">=</span> <span class="kc">None</span>

                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">JSON</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;json&#39;</span>
                       <span class="k">try</span><span class="p">:</span>
                           <span class="n">display_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                       <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                           <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Detail View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Could not serialize JSON field &#39;</span><span class="si">{</span><span class="n">field_name</span><span class="si">}</span><span class="s2">&#39; to string. Displaying raw value.&quot;</span><span class="p">)</span>
                           <span class="n">display_value</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">field_value</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>

                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Boolean</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;boolean&#39;</span>
                       <span class="n">display_value</span> <span class="o">=</span> <span class="s2">&quot;Yes&quot;</span> <span class="k">if</span> <span class="n">field_value</span> <span class="k">else</span> <span class="s2">&quot;No&quot;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;datetime&#39;</span>
                       <span class="n">display_value</span> <span class="o">=</span> <span class="n">field_value</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field_value</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;None&quot;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Integer</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;integer&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">String</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;string&#39;</span>
                  <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Text</span><span class="p">):</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;text&#39;</span>
                  <span class="k">else</span><span class="p">:</span>
                       <span class="n">field_type</span> <span class="o">=</span> <span class="s1">&#39;other&#39;</span>

             <span class="n">fields_to_display_data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                 <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">field_name</span><span class="p">,</span>
                 <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="n">display_value</span><span class="p">,</span>
                 <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="n">field_type</span><span class="p">,</span>
             <span class="p">})</span>

        <span class="n">fields_to_display_data</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">fields_to_display_data</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span>


        <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;model_name&quot;</span><span class="p">:</span> <span class="n">model_name</span><span class="p">,</span>
            <span class="s2">&quot;object&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="p">,</span>
            <span class="s2">&quot;fields_to_display&quot;</span><span class="p">:</span> <span class="n">fields_to_display_data</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;admin/generic_detail.html&quot;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error retrieving or rendering object </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> in detail view for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span></div>


<div class="viewcode-block" id="generic_delete_view">
<a class="viewcode-back" href="../../../lback/lback.admin.html#lback.admin.generic.generic_delete_view">[docs]</a>
<span class="nd">@PermissionRequired</span><span class="p">(</span><span class="k">lambda</span> <span class="n">request</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;delete_</span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">path_params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;model_name&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="s2">&quot;delete_unknown_model&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generic_delete_view</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">Request</span><span class="p">,</span> <span class="n">model</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">BaseModel</span><span class="p">],</span> <span class="n">object_id</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Response</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Handles the generic &quot;delete&quot; view for removing instances of a database model.</span>

<span class="sd">    This view is specifically designed to process POST requests for deletion to prevent</span>
<span class="sd">    accidental deletions via GET requests. It performs the following actions:</span>
<span class="sd">    - **Permission Checking**: Uses the `@PermissionRequired` decorator to ensure the user</span>
<span class="sd">      has the necessary permission (`delete_&lt;model_name&gt;`).</span>
<span class="sd">    - **Dependency Check**: Verifies the presence of a database session and configuration.</span>
<span class="sd">    - **HTTP Method Enforcement**: Ensures the request method is POST.</span>
<span class="sd">    - **Object Retrieval**: Fetches the object to be deleted by its `object_id`.</span>
<span class="sd">    - **AdminUser Specific Protections**: Implements special logic to prevent:</span>
<span class="sd">        - Deletion of the primary superuser (ID 1).</span>
<span class="sd">        - Non-primary superusers from deleting other superusers.</span>
<span class="sd">        - Non-superusers from deleting any `AdminUser`.</span>
<span class="sd">    - **Associated File Deletion**: Iterates through model attributes to identify and delete</span>
<span class="sd">      any associated files (e.g., fields ending with &#39;_file&#39; or &#39;_path&#39;) from the filesystem</span>
<span class="sd">      before deleting the database record.</span>
<span class="sd">    - **Database Deletion**: Deletes the object from the database and commits the transaction.</span>
<span class="sd">    - **Redirection**: Redirects to the model&#39;s list view upon successful deletion.</span>
<span class="sd">    - **Error Handling**: Provides robust error handling for object not found, forbidden</span>
<span class="sd">      operations, and unexpected exceptions during the deletion process.</span>

<span class="sd">    :param request: The incoming request object, containing the database session,</span>
<span class="sd">                    configuration, and the current user.</span>
<span class="sd">    :type request: Request</span>
<span class="sd">    :param model: The SQLAlchemy `BaseModel` class whose instance is to be deleted.</span>
<span class="sd">    :type model: Type[BaseModel]</span>
<span class="sd">    :param object_id: The primary key or unique identifier of the object to be deleted.</span>
<span class="sd">    :type object_id: Any</span>
<span class="sd">    :returns: A `Response` object, typically a redirect on success, or an error response</span>
<span class="sd">              (404, 403, or 500) on failure.</span>
<span class="sd">    :rtype: Response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;UnknownModel&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Handling generic delete view for model: </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID: </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">, Method: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
    <span class="n">db_session</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">SQLASession</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">db_session</span>
    <span class="n">config</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Config</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">config</span>
    <span class="n">current_user</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">db_session</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">critical</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Database session or Config is not available in generic_delete_view for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Internal Server Error: Database session or Config missing.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">POST</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Received non-POST request for delete submission for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">body</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Method Not Allowed&quot;</span><span class="p">,</span> <span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">METHOD_NOT_ALLOWED</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">,</span> <span class="s1">&#39;Allow&#39;</span><span class="p">:</span> <span class="n">HTTPMethod</span><span class="o">.</span><span class="n">POST</span><span class="o">.</span><span class="n">value</span><span class="p">})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">db_session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">model</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">object_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> not found for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> in delete view for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">return_404</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">message</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> not found for deletion.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">AdminUser</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdminUser with ID 1 (superuser) cannot be deleted. Attempt by user ID: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">current_user</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Deletion Forbidden: The primary superuser cannot be deleted.&quot;</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">current_user</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="n">AdminUser</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">current_user</span><span class="p">,</span> <span class="s1">&#39;is_superuser&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">is_superuser</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdminUser &#39;</span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) attempted to delete superuser AdminUser &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). Only AdminUser ID 1 can delete other superusers.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Deletion Forbidden: Only primary superuser (ID 1) can delete other superusers.&quot;</span><span class="p">,</span>
                                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdminUser ID 1 is attempting to delete superuser AdminUser &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). Proceeding.&quot;</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">current_user</span><span class="o">.</span><span class="n">is_superuser</span> <span class="ow">and</span> <span class="n">current_user</span><span class="o">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdminUser &#39;</span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) attempted to delete non-superuser AdminUser &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). Only superusers or Admin ID 1 can delete other admins.&quot;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Deletion Forbidden: You do not have sufficient privileges to delete other administrators.&quot;</span><span class="p">,</span>
                                        <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">})</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;AdminUser &#39;</span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">current_user</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">) is attempting to delete non-superuser AdminUser &#39;</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&#39; (ID: </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">). Proceeding.&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unauthorized or invalid user attempting to delete an AdminUser. Current user: </span><span class="si">{</span><span class="n">current_user</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">status_code</span><span class="o">=</span><span class="n">HTTPStatus</span><span class="o">.</span><span class="n">FORBIDDEN</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                <span class="n">data</span><span class="o">=</span><span class="sa">b</span><span class="s2">&quot;Deletion Forbidden: You must be an authenticated AdminUser with sufficient privileges.&quot;</span><span class="p">,</span>
                                <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;text/plain&#39;</span><span class="p">})</span>

        <span class="n">mapper</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">mapper</span><span class="o">.</span><span class="n">attrs</span><span class="p">:</span>
             <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                 <span class="n">column</span> <span class="o">=</span> <span class="n">attr</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                 <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">Text</span><span class="p">))</span> <span class="ow">and</span> <span class="p">(</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">)):</span>
                        <span class="n">file_path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">file_path</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                            
                            <span class="n">delete_saved_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">file_path</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generic Delete View for </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">, ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2">: Associated file path for field &#39;</span><span class="si">{</span><span class="n">attr</span><span class="o">.</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; is not a string: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">. Skipping deletion.&quot;</span><span class="p">)</span>

        <span class="n">db_session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Successfully deleted object with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="n">list_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/admin/</span><span class="si">{</span><span class="n">model_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="si">}</span><span class="s2">/&quot;</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">list_url</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">db_session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error deleting object with ID </span><span class="si">{</span><span class="n">object_id</span><span class="si">}</span><span class="s2"> for model </span><span class="si">{</span><span class="n">model_name</span><span class="si">}</span><span class="s2"> for </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">method</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">request</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">return_500</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">exception</span><span class="o">=</span><span class="n">e</span><span class="p">)</span></div>

</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Ibrahem abo kila.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>